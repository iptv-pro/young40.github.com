
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>2d-x深读3:CCObject - 喜气羊羊</title>
  <meta name="author" content="Young40">

  
  <meta name="description" content="CCObject是绝大部分cocos2d-x类的基类, 我们就从这里一步一步揭开cocos2d-x的奥秘. CCObject承担了两个重要的功能, 拷贝机制和内存管理. 拷贝机制 打开CCObject.h 首先看到的是类CCCopying, 而CCObject是从该类派生. &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://young40.github.com/blog/2012/12/31/cocos2d-x-source-code-research-3-ccobject/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="喜气羊羊" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-827720-7']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">喜气羊羊</a></h1>
  
    <h2>代码是一种人生态度</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS" target="_blank">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get" target="_blank">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:young40.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">首页</a></li>
  <li><a href="/blog/archives">文章</a></li>
  <li><a href="/about">关于</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">2d-x深读3:CCObject</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-12-31T17:21:00+08:00" pubdate data-updated="true">Dec 31<span>st</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>CCObject是绝大部分cocos2d-x类的基类, 我们就从这里一步一步揭开cocos2d-x的奥秘.</p>

<p>CCObject承担了两个重要的功能, 拷贝机制和内存管理.</p>

<h2>拷贝机制</h2>

<p>打开<code>CCObject.h</code> 首先看到的是类CCCopying, 而CCObject是从该类派生. 从这个意义上来讲CCCopying才是大部分类的基类. <br/>
但CCCopying其实非常简单, 再加上没有其他类从CCCopying派生, 所以说CCObject才是大部分类的基类也是不错的. 我认为CCCopying仅仅是一个接口性质.</p>

<p>CCCopying这个类非常简单, 只有一个成员函数copyWithZone(CCZone *pZone); 简单到其实现只是为了报错. 尽管如此, 但其却承担了拷贝机制这一重要的功能.</p>

<p>cocos2d-x和cocos2d-iphone是近亲, 所以cocos2d-x在API上会和cocos2d-iphone保持一致, 代码上也多有借鉴. CCObject明显就有很多NSObject的痕迹.
当然我对Objective-c并不熟悉, 这里都是些猜测罢了. copyWithZone或许就是借鉴了Obj-c.</p>

<p>我们先来看下拷贝机制, 至于CCObject的代码倒不忙着看.</p>

<!--more-->


<p>这两段代码来至于类CCArray, 我们可以看到调用了原对象的copy()来拷贝一份新的CCArray.<br/>
而copy()则定义于CCObject中, 其工作就是调用copyWithZone.</p>

<figure class='code'><figcaption><span>CCArray</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="n">CCArray</span><span class="o">*</span> <span class="n">CCArray</span><span class="o">::</span><span class="n">createWithArray</span><span class="p">(</span><span class="n">CCArray</span><span class="o">*</span> <span class="n">otherArray</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">CCArray</span><span class="o">*</span> <span class="n">pRet</span> <span class="o">=</span> <span class="p">(</span><span class="n">CCArray</span><span class="o">*</span><span class="p">)</span><span class="n">otherArray</span><span class="o">-&gt;</span><span class="n">copy</span><span class="p">();</span>
</span><span class='line'>    <span class="n">pRet</span><span class="o">-&gt;</span><span class="n">autorelease</span><span class="p">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">pRet</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">/////----------////</span>
</span><span class='line'><span class="n">CCObject</span><span class="o">*</span> <span class="n">CCArray</span><span class="o">::</span><span class="n">copyWithZone</span><span class="p">(</span><span class="n">CCZone</span><span class="o">*</span> <span class="n">pZone</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">CCAssert</span><span class="p">(</span><span class="n">pZone</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;CCArray should not be inherited.&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">CCArray</span><span class="o">*</span> <span class="n">pArray</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CCArray</span><span class="p">();</span>
</span><span class='line'>    <span class="n">pArray</span><span class="o">-&gt;</span><span class="n">initWithCapacity</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">CCObject</span><span class="o">*</span> <span class="n">pObj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="n">CCObject</span><span class="o">*</span> <span class="n">pTmpObj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="n">CCARRAY_FOREACH</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">pObj</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">pTmpObj</span> <span class="o">=</span> <span class="n">pObj</span><span class="o">-&gt;</span><span class="n">copy</span><span class="p">();</span>
</span><span class='line'>        <span class="n">pArray</span><span class="o">-&gt;</span><span class="n">addObject</span><span class="p">(</span><span class="n">pTmpObj</span><span class="p">);</span>
</span><span class='line'>        <span class="n">pTmpObj</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">pArray</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里面牵涉到两个概念, 深拷贝和浅拷贝. 不清楚的大家可以搜索下, 简而言之, 深拷贝才真正的完全拷贝. cocos2d-x实现的是深拷贝. <br/>
我们在上面CCArray::copyWithZone中可以看到拷贝时对array的各个成员也执行了copy()的动作. <br/>
这样才能防止如果obj2是obj1的浅拷贝, 很容易出现array的元素有可能被过早释放的情况.</p>

<p>这里我们还可以一并说下CCZone这个类, 这个类也很简单, 只有一个构造函数和成员变量.</p>

<figure class='code'><figcaption><span>CCZone</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">class</span> <span class="nc">CC_DLL</span> <span class="n">CCZone</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>    <span class="n">CCZone</span><span class="p">(</span><span class="n">CCObject</span> <span class="o">*</span><span class="n">pObject</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>    <span class="n">CCObject</span> <span class="o">*</span><span class="n">m_pCopyObject</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>我想CCZone存在的目的就是为了调用copyWithZone的时候对象传递方便.比如我们还可以看下CCSpeed的copyWithZone函数.</p>

<figure class='code'><figcaption><span>CCSpeed</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="n">CCObject</span> <span class="o">*</span><span class="n">CCSpeed</span><span class="o">::</span><span class="n">copyWithZone</span><span class="p">(</span><span class="n">CCZone</span> <span class="o">*</span><span class="n">pZone</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">CCZone</span><span class="o">*</span> <span class="n">pNewZone</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="n">CCSpeed</span><span class="o">*</span> <span class="n">pRet</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">pZone</span> <span class="o">&amp;&amp;</span> <span class="n">pZone</span><span class="o">-&gt;</span><span class="n">m_pCopyObject</span><span class="p">)</span> <span class="c1">//in case of being called at sub class</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">pRet</span> <span class="o">=</span> <span class="p">(</span><span class="n">CCSpeed</span><span class="o">*</span><span class="p">)(</span><span class="n">pZone</span><span class="o">-&gt;</span><span class="n">m_pCopyObject</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">pRet</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CCSpeed</span><span class="p">();</span>
</span><span class='line'>        <span class="n">pZone</span> <span class="o">=</span> <span class="n">pNewZone</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CCZone</span><span class="p">(</span><span class="n">pRet</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">CCAction</span><span class="o">::</span><span class="n">copyWithZone</span><span class="p">(</span><span class="n">pZone</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">pRet</span><span class="o">-&gt;</span><span class="n">initWithAction</span><span class="p">(</span> <span class="p">(</span><span class="n">CCActionInterval</span><span class="o">*</span><span class="p">)(</span><span class="n">m_pInnerAction</span><span class="o">-&gt;</span><span class="n">copy</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">autorelease</span><span class="p">())</span> <span class="p">,</span> <span class="n">m_fSpeed</span> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">CC_SAFE_DELETE</span><span class="p">(</span><span class="n">pNewZone</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">pRet</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们可以看到构建了一个pZone, 然后调用父类的<code>CCAction::copyWithZone(pZone);</code>. <br/>
完全是为了copyWithZone方便传递变量而创建的.</p>

<p>拷贝机制看起来有点复杂, 但其实用起来很简单. 我觉得就两点, 1,使用copy()调用 2.各个类对自己的copyWithZone负责.</p>

<h2>内存管理</h2>

<p>cocos2d-x的内存管理采用了引用计数的方法. 曾经看到过有人吐槽其内存管理在多线程下不好用.</p>

<p>CCObject及其子类的对象在创建时, 引用计数默认为1, 每次retain后引用计数加1. 每次release后引用计数减1.
被自动管理的对象引用计数为0时, 会被自动释放.</p>

<p>老G总结的内存管理使用的几点原则(见参考1): <br/>
- 原则1: 谁生成(new, copy)谁负责release. <br/>
- 原则2: 谁retain, 谁负责release.  <br/>
- 原则3: 对于使用了autorelease的对象则不必管他.</p>

<h2>几个常用的函数指针</h2>

<p>当我看到下面这两句的时候, 我完全懵了.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="n">CCObject</span><span class="o">::*</span><span class="n">SEL_SCHEDULE</span><span class="p">)(</span><span class="kt">float</span><span class="p">);</span>
</span><span class='line'><span class="cp">#define schedule_selector(_SELECTOR) (SEL_SCHEDULE)(&amp;_SELECTOR)</span>
</span></code></pre></td></tr></table></div></figure>


<p>
如果你也对函数指针不熟悉的话, 请翻下相关内容吧.
在这两句里面, 第一句其实是定义了一个返回类型为void的, 名字为SEL_SCHEDULE的, 参数为float的函数指针. <br/>
第二句其实是一个函数类型转换, 将(&amp;_SELECTOR)强制转换成SEL_SCHEDULE类型的函数指针.</p>

<p>通常需要回调函数的时候, 就需要用到这些函数指针. 这里就不再赘述, 以后应该会提及相关知识.</p>

<p>好, 我们接下来直接翻代码吧.</p>

<ul>
<li>版本:<code>cocos2d-2.1beta3-x-2.1.0</code></li>
<li>路径:<code>cocos2d-2.1beta3-x-2.1.0/cocos2dx/cocoa/CCObject.h</code></li>
<li>路径:<code>cocos2d-2.1beta3-x-2.1.0/cocos2dx/cocoa/CCObject.cpp</code></li>
</ul>


<figure class='code'><figcaption><span>CCobject&#46;h   (CCObject.h)</span> <a href='/downloads/code/cocos2d-x-research/2.1.1/cocos2dx/cocoa/CCObject.h'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">class</span> <span class="nc">CC_DLL</span> <span class="n">CCCopying</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>    <span class="k">virtual</span> <span class="n">CCObject</span><span class="o">*</span> <span class="n">copyWithZone</span><span class="p">(</span><span class="n">CCZone</span><span class="o">*</span> <span class="n">pZone</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">CC_DLL</span> <span class="n">CCObject</span> <span class="o">:</span> <span class="k">public</span> <span class="n">CCCopying</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">int</span>        <span class="n">m_uID</span><span class="p">;</span><span class="c1">//这两个是支持lua等脚本语言用的, 我们不去管他.</span>
</span><span class='line'>    <span class="kt">int</span>                 <span class="n">m_nLuaID</span><span class="p">;</span>
</span><span class='line'><span class="k">protected</span><span class="o">:</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">int</span>        <span class="n">m_uReference</span><span class="p">;</span><span class="c1">//引用计数</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">int</span>        <span class="n">m_uAutoReleaseCount</span><span class="p">;</span><span class="c1">//autorelease计数</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>    <span class="n">CCObject</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'>    <span class="k">virtual</span> <span class="o">~</span><span class="n">CCObject</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">void</span> <span class="n">release</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">void</span> <span class="n">retain</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'>    <span class="n">CCObject</span><span class="o">*</span> <span class="n">autorelease</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'>    <span class="n">CCObject</span><span class="o">*</span> <span class="n">copy</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">bool</span> <span class="n">isSingleReference</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">retainCount</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'>    <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">isEqual</span><span class="p">(</span><span class="k">const</span> <span class="n">CCObject</span><span class="o">*</span> <span class="n">pObject</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">update</span><span class="p">(</span><span class="kt">float</span> <span class="n">dt</span><span class="p">)</span> <span class="p">{</span><span class="n">CC_UNUSED_PARAM</span><span class="p">(</span><span class="n">dt</span><span class="p">);};</span>
</span><span class='line'>   <span class="c1">//CCAutoreleasePool作为友元类 </span>
</span><span class='line'>    <span class="k">friend</span> <span class="k">class</span> <span class="nc">CCAutoreleasePool</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//几个常用的函数指针.</span>
</span><span class='line'><span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="n">CCObject</span><span class="o">::*</span><span class="n">SEL_SCHEDULE</span><span class="p">)(</span><span class="kt">float</span><span class="p">);</span>
</span><span class='line'><span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="n">CCObject</span><span class="o">::*</span><span class="n">SEL_CallFunc</span><span class="p">)();</span>
</span><span class='line'><span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="n">CCObject</span><span class="o">::*</span><span class="n">SEL_CallFuncN</span><span class="p">)(</span><span class="n">CCNode</span><span class="o">*</span><span class="p">);</span>
</span><span class='line'><span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="n">CCObject</span><span class="o">::*</span><span class="n">SEL_CallFuncND</span><span class="p">)(</span><span class="n">CCNode</span><span class="o">*</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span><span class="p">);</span>
</span><span class='line'><span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="n">CCObject</span><span class="o">::*</span><span class="n">SEL_CallFuncO</span><span class="p">)(</span><span class="n">CCObject</span><span class="o">*</span><span class="p">);</span>
</span><span class='line'><span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="n">CCObject</span><span class="o">::*</span><span class="n">SEL_MenuHandler</span><span class="p">)(</span><span class="n">CCObject</span><span class="o">*</span><span class="p">);</span>
</span><span class='line'><span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="n">CCObject</span><span class="o">::*</span><span class="n">SEL_EventHandler</span><span class="p">)(</span><span class="n">CCEvent</span><span class="o">*</span><span class="p">);</span>
</span><span class='line'><span class="k">typedef</span> <span class="kt">int</span> <span class="p">(</span><span class="n">CCObject</span><span class="o">::*</span><span class="n">SEL_Compare</span><span class="p">)(</span><span class="n">CCObject</span><span class="o">*</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define schedule_selector(_SELECTOR) (SEL_SCHEDULE)(&amp;_SELECTOR)</span>
</span><span class='line'><span class="cp">#define callfunc_selector(_SELECTOR) (SEL_CallFunc)(&amp;_SELECTOR)</span>
</span><span class='line'><span class="cp">#define callfuncN_selector(_SELECTOR) (SEL_CallFuncN)(&amp;_SELECTOR)</span>
</span><span class='line'><span class="cp">#define callfuncND_selector(_SELECTOR) (SEL_CallFuncND)(&amp;_SELECTOR)</span>
</span><span class='line'><span class="cp">#define callfuncO_selector(_SELECTOR) (SEL_CallFuncO)(&amp;_SELECTOR)</span>
</span><span class='line'><span class="cp">#define menu_selector(_SELECTOR) (SEL_MenuHandler)(&amp;_SELECTOR)</span>
</span><span class='line'><span class="cp">#define event_selector(_SELECTOR) (SEL_EventHandler)(&amp;_SELECTOR)</span>
</span><span class='line'><span class="cp">#define compare_selector(_SELECTOR) (SEL_Compare)(&amp;_SELECTOR)</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span>CCobject&#46;cpp   (CCObject.cpp)</span> <a href='/downloads/code/cocos2d-x-research/2.1.1/cocos2dx/cocoa/CCObject.cpp'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="n">CCObject</span><span class="o">*</span> <span class="n">CCCopying</span><span class="o">::</span><span class="n">copyWithZone</span><span class="p">(</span><span class="n">CCZone</span> <span class="o">*</span><span class="n">pZone</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span><span class="c1">//CCObject的派生类需要调用copy()则必须重写该函数</span>
</span><span class='line'>    <span class="n">CC_UNUSED_PARAM</span><span class="p">(</span><span class="n">pZone</span><span class="p">);</span>
</span><span class='line'>    <span class="n">CCAssert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;not implement&quot;</span><span class="p">);</span><span class="c1">//不重写会报错.</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">CCObject</span><span class="o">::</span><span class="n">CCObject</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="o">:</span><span class="n">m_uAutoReleaseCount</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="p">,</span><span class="n">m_uReference</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">// 引用计数默认为1</span>
</span><span class='line'><span class="p">,</span><span class="n">m_nLuaID</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uObjectCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">m_uID</span> <span class="o">=</span> <span class="o">++</span><span class="n">uObjectCount</span><span class="p">;</span><span class="c1">//脚本语言相关, 不去管他.</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">CCObject</span><span class="o">::~</span><span class="n">CCObject</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span><span class="c1">//析构函数</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">m_uAutoReleaseCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span><span class="c1">//自动引用计数则从管理池中删除</span>
</span><span class='line'>        <span class="n">CCPoolManager</span><span class="o">::</span><span class="n">sharedPoolManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">removeObject</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">m_nLuaID</span><span class="p">)</span><span class="c1">//脚本语言相关.</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">CCScriptEngineManager</span><span class="o">::</span><span class="n">sharedManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getScriptEngine</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">removeScriptObjectByCCObject</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>    <span class="p">{</span><span class="c1">//看起来脚本语言支持被深度嵌入, 如果能设置个宏直接去掉其支持多好.</span>
</span><span class='line'>        <span class="n">CCScriptEngineProtocol</span><span class="o">*</span> <span class="n">pEngine</span> <span class="o">=</span> <span class="n">CCScriptEngineManager</span><span class="o">::</span><span class="n">sharedManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getScriptEngine</span><span class="p">();</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">pEngine</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">pEngine</span><span class="o">-&gt;</span><span class="n">getScriptType</span><span class="p">()</span> <span class="o">==</span> <span class="n">kScriptTypeJavascript</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">pEngine</span><span class="o">-&gt;</span><span class="n">removeScriptObjectByCCObject</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// copy实质上是对copyWithZone的调用.</span>
</span><span class='line'><span class="n">CCObject</span><span class="o">*</span> <span class="n">CCObject</span><span class="o">::</span><span class="n">copy</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">copyWithZone</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">CCObject</span><span class="o">::</span><span class="n">release</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">CCAssert</span><span class="p">(</span><span class="n">m_uReference</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;reference count should greater than 0&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="o">--</span><span class="n">m_uReference</span><span class="p">;</span><span class="c1">//引用计数自减</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">m_uReference</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span><span class="c1">//如果引用计数为0, 调用release会立即释放内存.</span>
</span><span class='line'>        <span class="k">delete</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">CCObject</span><span class="o">::</span><span class="n">retain</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">CCAssert</span><span class="p">(</span><span class="n">m_uReference</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;reference count should greater than 0&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="o">++</span><span class="n">m_uReference</span><span class="p">;</span><span class="c1">//引用计数自增.</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">CCObject</span><span class="o">*</span> <span class="n">CCObject</span><span class="o">::</span><span class="n">autorelease</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span><span class="c1">//autorelease将对象加入自动内存管理池.</span>
</span><span class='line'>    <span class="n">CCPoolManager</span><span class="o">::</span><span class="n">sharedPoolManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">addObject</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">bool</span> <span class="n">CCObject</span><span class="o">::</span><span class="n">isSingleReference</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span><span class="c1">//判断对象是否仅被引用了一次</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">m_uReference</span> <span class="o">==</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">CCObject</span><span class="o">::</span><span class="n">retainCount</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span><span class="c1">//返回引用次数</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">m_uReference</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">bool</span> <span class="n">CCObject</span><span class="o">::</span><span class="n">isEqual</span><span class="p">(</span><span class="k">const</span> <span class="n">CCObject</span> <span class="o">*</span><span class="n">pObject</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span><span class="c1">//判断对象是否为同一个对象.</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">this</span> <span class="o">==</span> <span class="n">pObject</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>参考1: http://4137613.blog.51cto.com/4127613/784134</li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Young40</span></span>

      








  


<time datetime="2012-12-31T17:21:00+08:00" pubdate data-updated="true">Dec 31<span>st</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/cocos2d-x/'>Cocos2d-x</a>, <a class='category' href='/blog/categories/cocos2d-x-源代码研究/'>Cocos2d-x 源代码研究</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/12/29/cocosbuilder-step-by-step-part-four/" title="Previous Post: 一步一步CocosBuilder(4)[完结]">&laquo; 一步一步CocosBuilder(4)[完结]</a>
      
      
        <a class="basic-alignment right" href="/blog/2013/01/03/cocos2d-x-source-code-research-4-ccautoreleasepool/" title="Next Post: 2d-x深读4:CCAutoReleasePool">2d-x深读4:CCAutoReleasePool &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
<h1>Categories</h1>
<ul id="categories">
    <li class='category'><a href='/blog/categories/cpp/'>CPP (2)</a></li>
<li class='category'><a href='/blog/categories/cocos2d-x/'>Cocos2d-x (10)</a></li>
<li class='category'><a href='/blog/categories/cocos2d-x-源代码研究/'>Cocos2d-x 源代码研究 (4)</a></li>
<li class='category'><a href='/blog/categories/cocosbuilder/'>CocosBuilder (5)</a></li>
<li class='category'><a href='/blog/categories/git/'>Git (1)</a></li>
<li class='category'><a href='/blog/categories/github/'>Github (1)</a></li>
<li class='category'><a href='/blog/categories/os-x/'>OS X (1)</a></li>
<li class='category'><a href='/blog/categories/shell/'>Shell (1)</a></li>
<li class='category'><a href='/blog/categories/vim/'>Vim (1)</a></li>
<li class='category'><a href='/blog/categories/杂谈/'>杂谈 (2)</a></li>

</ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/01/08/chat-of-pomelo-for-cocos2d-x/">基于Pomelo和Cocos2d-x的聊天室</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/03/cocos2d-x-source-code-research-4-ccautoreleasepool/">2d-x深读4:CCAutoReleasePool</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/31/cocos2d-x-source-code-research-3-ccobject/">2d-x深读3:CCObject</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/29/cocosbuilder-step-by-step-part-four/">一步一步CocosBuilder(4)[完结]</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/28/cocosbuilder-step-by-step-part-three/">一步一步CocosBuilder(3)</a>
      </li>
    
  </ul>
</section>






  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Young40 -
  <span class="credit">Powered by <a target="_blank" href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'young40';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://young40.github.com/blog/2012/12/31/cocos2d-x-source-code-research-3-ccobject/';
        var disqus_url = 'http://young40.github.com/blog/2012/12/31/cocos2d-x-source-code-research-3-ccobject/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
