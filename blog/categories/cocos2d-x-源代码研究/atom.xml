<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Cocos2d-x 源代码研究 | 喜气羊羊]]></title>
  <link href="http://young40.github.com/blog/categories/cocos2d-x-源代码研究/atom.xml" rel="self"/>
  <link href="http://young40.github.com/"/>
  <updated>2013-01-04T06:06:55+08:00</updated>
  <id>http://young40.github.com/</id>
  <author>
    <name><![CDATA[Young40]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[2d-x深读4:CCAutoReleasePool]]></title>
    <link href="http://young40.github.com/blog/2013/01/03/cocos2d-x-source-code-research-4-ccautoreleasepool/"/>
    <updated>2013-01-03T15:09:00+08:00</updated>
    <id>http://young40.github.com/blog/2013/01/03/cocos2d-x-source-code-research-4-ccautoreleasepool</id>
    <content type="html"><![CDATA[<p><code>CCAutoReleasePool.h</code>主要定义了两个类<code>CCAutoReleasePool</code>和<code>CCPoolManager</code>.</p>

<p>其实因为cocos2d-x自动管理内存的原因, 所以, 我们平时很少需要直接使用这两个类.  <br/>
为了探究其中的自动管理内存的机制, 我们直接分析其代码.</p>

<p>总体上来讲, 内存管理这块的机制难度或许比较大. 我研究了一天, 还是有诸多疑问.  <br/>
暂时先放一放, 待我功力进化后再来继续研究这块.</p>

<!--more-->


<ul>
<li>版本:<code>cocos2d-2.1beta3-x-2.1.0</code></li>
<li>路径:<code>cocos2d-2.1beta3-x-2.1.0/cocos2dx/cocoa/CCAutoReleasePool.h</code></li>
<li>路径:<code>cocos2d-2.1beta3-x-2.1.0/cocos2dx/cocoa/CCAutoReleasePool.cpp</code></li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>CCAutoReleasePool.h   (CCAutoReleasePool.h)</span> <a href='/downloads/code/cocos2d-x-research/2.1.1/cocos2dx/cocoa/CCAutoReleasePool.h'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="c1">// 声明CCAutoreleasePool类</span>
</span><span class='line'><span class="k">class</span> <span class="nc">CC_DLL</span> <span class="n">CCAutoreleasePool</span> <span class="o">:</span> <span class="k">public</span> <span class="n">CCObject</span>
</span><span class='line'><span class="p">{</span><span class="c1">//注意这个m_pCurReleasePool是一个私有成员. 居然没有加标号.</span>
</span><span class='line'>    <span class="n">CCArray</span><span class="o">*</span>    <span class="n">m_pManagedObjectArray</span><span class="p">;</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>    <span class="n">CCAutoreleasePool</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'>    <span class="o">~</span><span class="n">CCAutoreleasePool</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">void</span> <span class="n">addObject</span><span class="p">(</span><span class="n">CCObject</span> <span class="o">*</span><span class="n">pObject</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">void</span> <span class="n">removeObject</span><span class="p">(</span><span class="n">CCObject</span> <span class="o">*</span><span class="n">pObject</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">void</span> <span class="n">clear</span><span class="p">();</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">CC_DLL</span> <span class="n">CCPoolManager</span>
</span><span class='line'><span class="p">{</span><span class="c1">//下面这三个成员变量依然是私有的.</span>
</span><span class='line'>    <span class="n">CCArray</span><span class="o">*</span>    <span class="n">m_pReleasePoolStack</span><span class="p">;</span>
</span><span class='line'>    <span class="n">CCAutoreleasePool</span><span class="o">*</span>                    <span class="n">m_pCurReleasePool</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">CCAutoreleasePool</span><span class="o">*</span> <span class="n">getCurReleasePool</span><span class="p">();</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>    <span class="n">CCPoolManager</span><span class="p">();</span>
</span><span class='line'>    <span class="o">~</span><span class="n">CCPoolManager</span><span class="p">();</span>
</span><span class='line'>    <span class="kt">void</span> <span class="n">finalize</span><span class="p">();</span>
</span><span class='line'>    <span class="kt">void</span> <span class="n">push</span><span class="p">();</span>
</span><span class='line'>    <span class="kt">void</span> <span class="n">pop</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">void</span> <span class="n">removeObject</span><span class="p">(</span><span class="n">CCObject</span><span class="o">*</span> <span class="n">pObject</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">void</span> <span class="n">addObject</span><span class="p">(</span><span class="n">CCObject</span><span class="o">*</span> <span class="n">pObject</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">static</span> <span class="n">CCPoolManager</span><span class="o">*</span> <span class="n">sharedPoolManager</span><span class="p">();</span>
</span><span class='line'>    <span class="k">static</span> <span class="kt">void</span> <span class="n">purgePoolManager</span><span class="p">();</span>
</span><span class='line'>    <span class="c1">//友元</span>
</span><span class='line'>    <span class="k">friend</span> <span class="k">class</span> <span class="nc">CCAutoreleasePool</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>CCAutoReleasePool.cpp   (CCAutoReleasePool.cpp)</span> <a href='/downloads/code/cocos2d-x-research/2.1.1/cocos2dx/cocoa/CCAutoReleasePool.cpp'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">static</span> <span class="n">CCPoolManager</span><span class="o">*</span> <span class="n">s_pPoolManager</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span><span class="c1">// 用作单例模式的静态变量.</span>
</span><span class='line'>
</span><span class='line'><span class="n">CCAutoreleasePool</span><span class="o">::</span><span class="n">CCAutoreleasePool</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">m_pManagedObjectArray</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CCArray</span><span class="p">();</span>
</span><span class='line'>    <span class="n">m_pManagedObjectArray</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">CCAutoreleasePool</span><span class="o">::~</span><span class="n">CCAutoreleasePool</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">CC_SAFE_DELETE</span><span class="p">(</span><span class="n">m_pManagedObjectArray</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">CCAutoreleasePool</span><span class="o">::</span><span class="n">addObject</span><span class="p">(</span><span class="n">CCObject</span><span class="o">*</span> <span class="n">pObject</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">m_pManagedObjectArray</span><span class="o">-&gt;</span><span class="n">addObject</span><span class="p">(</span><span class="n">pObject</span><span class="p">);</span>
</span><span class='line'>    <span class="c1">// CCAutoreleasePool是CCObject的友元类, 可以直接访问CCObject的protect成员变量.</span>
</span><span class='line'>    <span class="n">CCAssert</span><span class="p">(</span><span class="n">pObject</span><span class="o">-&gt;</span><span class="n">m_uReference</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;reference count should be greater than 1&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="o">++</span><span class="p">(</span><span class="n">pObject</span><span class="o">-&gt;</span><span class="n">m_uAutoReleaseCount</span><span class="p">);</span>
</span><span class='line'>    <span class="n">pObject</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">();</span> <span class="c1">// no ref count, in this case autorelease pool added.</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// 下面这个遍历似乎是为了应对被多次加入pool</span>
</span><span class='line'><span class="kt">void</span> <span class="n">CCAutoreleasePool</span><span class="o">::</span><span class="n">removeObject</span><span class="p">(</span><span class="n">CCObject</span><span class="o">*</span> <span class="n">pObject</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pObject</span><span class="o">-&gt;</span><span class="n">m_uAutoReleaseCount</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">m_pManagedObjectArray</span><span class="o">-&gt;</span><span class="n">removeObject</span><span class="p">(</span><span class="n">pObject</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// 清空池</span>
</span><span class='line'><span class="kt">void</span> <span class="n">CCAutoreleasePool</span><span class="o">::</span><span class="n">clear</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">m_pManagedObjectArray</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="c1">//CCAutoreleasePool* pReleasePool;</span>
</span><span class='line'><span class="cp">#ifdef _DEBUG</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">nIndex</span> <span class="o">=</span> <span class="n">m_pManagedObjectArray</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">CCObject</span><span class="o">*</span> <span class="n">pObj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>        <span class="n">CCARRAY_FOREACH_REVERSE</span><span class="p">(</span><span class="n">m_pManagedObjectArray</span><span class="p">,</span> <span class="n">pObj</span><span class="p">)</span><span class="c1">//反序遍历</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="c1">// 这里还是令人费解, 为何会使用break, 而不是使用continue完成遍历????</span>
</span><span class='line'>            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pObj</span><span class="p">)</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="o">--</span><span class="p">(</span><span class="n">pObj</span><span class="o">-&gt;</span><span class="n">m_uAutoReleaseCount</span><span class="p">);</span>
</span><span class='line'>            <span class="c1">//(*it)-&gt;release();</span>
</span><span class='line'>            <span class="c1">//delete (*it);</span>
</span><span class='line'><span class="cp">#ifdef _DEBUG</span>
</span><span class='line'>            <span class="n">nIndex</span><span class="o">--</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">m_pManagedObjectArray</span><span class="o">-&gt;</span><span class="n">removeAllObjects</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// CCPoolManager的单例</span>
</span><span class='line'><span class="n">CCPoolManager</span><span class="o">*</span> <span class="n">CCPoolManager</span><span class="o">::</span><span class="n">sharedPoolManager</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">s_pPoolManager</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">s_pPoolManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CCPoolManager</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">s_pPoolManager</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 销毁当前manager</span>
</span><span class='line'><span class="kt">void</span> <span class="n">CCPoolManager</span><span class="o">::</span><span class="n">purgePoolManager</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">CC_SAFE_DELETE</span><span class="p">(</span><span class="n">s_pPoolManager</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">//构造函数</span>
</span><span class='line'><span class="n">CCPoolManager</span><span class="o">::</span><span class="n">CCPoolManager</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">m_pReleasePoolStack</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CCArray</span><span class="p">();</span>
</span><span class='line'>    <span class="n">m_pReleasePoolStack</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">();</span>
</span><span class='line'>    <span class="n">m_pCurReleasePool</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// 析构函数</span>
</span><span class='line'><span class="n">CCPoolManager</span><span class="o">::~</span><span class="n">CCPoolManager</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>     <span class="n">finalize</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>     <span class="c1">// 这个注释也让人费解. 为什么只移除第一个, 而不是遍历????</span>
</span><span class='line'>     <span class="c1">// we only release the last autorelease pool here </span>
</span><span class='line'>    <span class="n">m_pCurReleasePool</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>     <span class="n">m_pReleasePoolStack</span><span class="o">-&gt;</span><span class="n">removeObjectAtIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>     <span class="n">CC_SAFE_DELETE</span><span class="p">(</span><span class="n">m_pReleasePoolStack</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">CCPoolManager</span><span class="o">::</span><span class="n">finalize</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">m_pReleasePoolStack</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="c1">//CCAutoreleasePool* pReleasePool;</span>
</span><span class='line'>        <span class="n">CCObject</span><span class="o">*</span> <span class="n">pObj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>        <span class="n">CCARRAY_FOREACH</span><span class="p">(</span><span class="n">m_pReleasePoolStack</span><span class="p">,</span> <span class="n">pObj</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="c1">// 这里有点令人不解, 为什么遍历还没有完成就break了??? </span>
</span><span class='line'>            <span class="c1">// 或许是因为pop push的方式不会在中间产生为NULL的池.</span>
</span><span class='line'>            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pObj</span><span class="p">)</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="n">CCAutoreleasePool</span><span class="o">*</span> <span class="n">pPool</span> <span class="o">=</span> <span class="p">(</span><span class="n">CCAutoreleasePool</span><span class="o">*</span><span class="p">)</span><span class="n">pObj</span><span class="p">;</span>
</span><span class='line'>            <span class="n">pPool</span><span class="o">-&gt;</span><span class="n">clear</span><span class="p">();</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">//创建一个新池, 注意其中pPool的引用计数的变化.</span>
</span><span class='line'><span class="kt">void</span> <span class="n">CCPoolManager</span><span class="o">::</span><span class="n">push</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">CCAutoreleasePool</span><span class="o">*</span> <span class="n">pPool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CCAutoreleasePool</span><span class="p">();</span>       <span class="c1">//ref = 1</span>
</span><span class='line'>    <span class="n">m_pCurReleasePool</span> <span class="o">=</span> <span class="n">pPool</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">m_pReleasePoolStack</span><span class="o">-&gt;</span><span class="n">addObject</span><span class="p">(</span><span class="n">pPool</span><span class="p">);</span>                   <span class="c1">//ref = 2</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">pPool</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">();</span>                                       <span class="c1">//ref = 1</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">//销毁当前池</span>
</span><span class='line'><span class="kt">void</span> <span class="n">CCPoolManager</span><span class="o">::</span><span class="n">pop</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">m_pCurReleasePool</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="kt">int</span> <span class="n">nCount</span> <span class="o">=</span> <span class="n">m_pReleasePoolStack</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">m_pCurReleasePool</span><span class="o">-&gt;</span><span class="n">clear</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">nCount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span><span class="c1">//注意这里removeObjectAtIndex会将当前池的引用技术减1, 从而销毁当前池.</span>
</span><span class='line'>        <span class="n">m_pReleasePoolStack</span><span class="o">-&gt;</span><span class="n">removeObjectAtIndex</span><span class="p">(</span><span class="n">nCount</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//         if(nCount &gt; 1)</span>
</span><span class='line'><span class="c1">//         {</span>
</span><span class='line'><span class="c1">//             m_pCurReleasePool = m_pReleasePoolStack-&gt;objectAtIndex(nCount - 2);</span>
</span><span class='line'><span class="c1">//             return;</span>
</span><span class='line'><span class="c1">//         }</span>
</span><span class='line'>        <span class="n">m_pCurReleasePool</span> <span class="o">=</span> <span class="p">(</span><span class="n">CCAutoreleasePool</span><span class="o">*</span><span class="p">)</span><span class="n">m_pReleasePoolStack</span><span class="o">-&gt;</span><span class="n">objectAtIndex</span><span class="p">(</span><span class="n">nCount</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="c1">//如果没有意外, 这里会最少保留一个池不会被销毁. 但最后一个池还是会被清空..</span>
</span><span class='line'>    <span class="cm">/*m_pCurReleasePool = NULL;*/</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// 从当前池中移除对象.</span>
</span><span class='line'><span class="kt">void</span> <span class="n">CCPoolManager</span><span class="o">::</span><span class="n">removeObject</span><span class="p">(</span><span class="n">CCObject</span><span class="o">*</span> <span class="n">pObject</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">CCAssert</span><span class="p">(</span><span class="n">m_pCurReleasePool</span><span class="p">,</span> <span class="s">&quot;current auto release pool should not be null&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">m_pCurReleasePool</span><span class="o">-&gt;</span><span class="n">removeObject</span><span class="p">(</span><span class="n">pObject</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">//添加一个对象到当前池</span>
</span><span class='line'><span class="kt">void</span> <span class="n">CCPoolManager</span><span class="o">::</span><span class="n">addObject</span><span class="p">(</span><span class="n">CCObject</span><span class="o">*</span> <span class="n">pObject</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">getCurReleasePool</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">addObject</span><span class="p">(</span><span class="n">pObject</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//形成单例模式</span>
</span><span class='line'><span class="n">CCAutoreleasePool</span><span class="o">*</span> <span class="n">CCPoolManager</span><span class="o">::</span><span class="n">getCurReleasePool</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">m_pCurReleasePool</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">push</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">CCAssert</span><span class="p">(</span><span class="n">m_pCurReleasePool</span><span class="p">,</span> <span class="s">&quot;current auto release pool should not be null&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">m_pCurReleasePool</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li>参考1: http://4137613.blog.51cto.com/4127613/784134</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[2d-x深读3:CCObject]]></title>
    <link href="http://young40.github.com/blog/2012/12/31/cocos2d-x-source-code-research-3-ccobject/"/>
    <updated>2012-12-31T17:21:00+08:00</updated>
    <id>http://young40.github.com/blog/2012/12/31/cocos2d-x-source-code-research-3-ccobject</id>
    <content type="html"><![CDATA[<p>CCObject是绝大部分cocos2d-x类的基类, 我们就从这里一步一步揭开cocos2d-x的奥秘.</p>

<p>CCObject承担了两个重要的功能, 拷贝机制和内存管理.</p>

<h2>拷贝机制</h2>

<p>打开<code>CCObject.h</code> 首先看到的是类CCCopying, 而CCObject是从该类派生. 从这个意义上来讲CCCopying才是大部分类的基类. <br/>
但CCCopying其实非常简单, 再加上没有其他类从CCCopying派生, 所以说CCObject才是大部分类的基类也是不错的. 我认为CCCopying仅仅是一个接口性质.</p>

<p>CCCopying这个类非常简单, 只有一个成员函数copyWithZone(CCZone *pZone); 简单到其实现只是为了报错. 尽管如此, 但其却承担了拷贝机制这一重要的功能.</p>

<p>cocos2d-x和cocos2d-iphone是近亲, 所以cocos2d-x在API上会和cocos2d-iphone保持一致, 代码上也多有借鉴. CCObject明显就有很多NSObject的痕迹.
当然我对Objective-c并不熟悉, 这里都是些猜测罢了. copyWithZone或许就是借鉴了Obj-c.</p>

<p>我们先来看下拷贝机制, 至于CCObject的代码倒不忙着看.</p>

<!--more-->


<p>这两段代码来至于类CCArray, 我们可以看到调用了原对象的copy()来拷贝一份新的CCArray.<br/>
而copy()则定义于CCObject中, 其工作就是调用copyWithZone.</p>

<p>``` cpp CCArray
CCArray<em> CCArray::createWithArray(CCArray</em> otherArray)
{</p>

<pre><code>CCArray* pRet = (CCArray*)otherArray-&gt;copy();
pRet-&gt;autorelease();
return pRet;
</code></pre>

<p>}
/////----------////
CCObject<em> CCArray::copyWithZone(CCZone</em> pZone)
{</p>

<pre><code>CCAssert(pZone == NULL, "CCArray should not be inherited.");
CCArray* pArray = new CCArray();
pArray-&gt;initWithCapacity(this-&gt;data-&gt;num &gt; 0 ? this-&gt;data-&gt;num : 1);

CCObject* pObj = NULL;
CCObject* pTmpObj = NULL;
CCARRAY_FOREACH(this, pObj)
{
    pTmpObj = pObj-&gt;copy();
    pArray-&gt;addObject(pTmpObj);
    pTmpObj-&gt;release();
}
return pArray;
</code></pre>

<p>}
```
这里面牵涉到两个概念, 深拷贝和浅拷贝. 不清楚的大家可以搜索下, 简而言之, 深拷贝才真正的完全拷贝. cocos2d-x实现的是深拷贝. <br/>
我们在上面CCArray::copyWithZone中可以看到拷贝时对array的各个成员也执行了copy()的动作. <br/>
这样才能防止如果obj2是obj1的浅拷贝, 很容易出现array的元素有可能被过早释放的情况.</p>

<p>这里我们还可以一并说下CCZone这个类, 这个类也很简单, 只有一个构造函数和成员变量. <br/>
``` cpp CCZone
class CC_DLL CCZone
{
public:</p>

<pre><code>CCZone(CCObject *pObject = NULL);
</code></pre>

<p>public:</p>

<pre><code>CCObject *m_pCopyObject;
</code></pre>

<p>};
<code>
我想CCZone存在的目的就是为了调用copyWithZone的时候对象传递方便.比如我们还可以看下CCSpeed的copyWithZone函数.   
</code> cpp CCSpeed
CCObject <em>CCSpeed::copyWithZone(CCZone </em>pZone)
{</p>

<pre><code>CCZone* pNewZone = NULL;
CCSpeed* pRet = NULL;
if(pZone &amp;&amp; pZone-&gt;m_pCopyObject) //in case of being called at sub class
{
    pRet = (CCSpeed*)(pZone-&gt;m_pCopyObject);
}
else
{
    pRet = new CCSpeed();
    pZone = pNewZone = new CCZone(pRet);
}
CCAction::copyWithZone(pZone);

pRet-&gt;initWithAction( (CCActionInterval*)(m_pInnerAction-&gt;copy()-&gt;autorelease()) , m_fSpeed );

CC_SAFE_DELETE(pNewZone);
return pRet;
</code></pre>

<p>}
<code>``
我们可以看到构建了一个pZone, 然后调用父类的</code>CCAction::copyWithZone(pZone);`. <br/>
完全是为了copyWithZone方便传递变量而创建的.</p>

<p>拷贝机制看起来有点复杂, 但其实用起来很简单. 我觉得就两点, 1,使用copy()调用 2.各个类对自己的copyWithZone负责.</p>

<h2>内存管理</h2>

<p>cocos2d-x的内存管理采用了引用计数的方法. 曾经看到过有人吐槽其内存管理在多线程下不好用.</p>

<p>CCObject及其子类的对象在创建时, 引用计数默认为1, 每次retain后引用计数加1. 每次release后引用计数减1.
被自动管理的对象引用计数为0时, 会被自动释放.</p>

<p>老G总结的内存管理使用的几点原则(见参考1): <br/>
- 原则1: 谁生成(new, copy)谁负责release. <br/>
- 原则2: 谁retain, 谁负责release.  <br/>
- 原则3: 对于使用了autorelease的对象则不必管他.</p>

<h2>几个常用的函数指针</h2>

<p>当我看到下面这两句的时候, 我完全懵了. <br/>
``` cpp
typedef void (CCObject::*SEL_SCHEDULE)(float);</p>

<h1>define schedule_selector(<em>SELECTOR) (SEL_SCHEDULE)(&amp;</em>SELECTOR)</h1>

<p>```
如果你也对函数指针不熟悉的话, 请翻下相关内容吧.
在这两句里面, 第一句其实是定义了一个返回类型为void的, 名字为SEL_SCHEDULE的, 参数为float的函数指针. <br/>
第二句其实是一个函数类型转换, 将(&amp;_SELECTOR)强制转换成SEL_SCHEDULE类型的函数指针.</p>

<p>通常需要回调函数的时候, 就需要用到这些函数指针. 这里就不再赘述, 以后应该会提及相关知识.</p>

<p>好, 我们接下来直接翻代码吧.</p>

<ul>
<li>版本:<code>cocos2d-2.1beta3-x-2.1.0</code></li>
<li>路径:<code>cocos2d-2.1beta3-x-2.1.0/cocos2dx/cocoa/CCObject.h</code></li>
<li>路径:<code>cocos2d-2.1beta3-x-2.1.0/cocos2dx/cocoa/CCObject.cpp</code></li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>CCobject.h   (CCObject.h)</span> <a href='/downloads/code/cocos2d-x-research/2.1.1/cocos2dx/cocoa/CCObject.h'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">class</span> <span class="nc">CC_DLL</span> <span class="n">CCCopying</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>    <span class="k">virtual</span> <span class="n">CCObject</span><span class="o">*</span> <span class="n">copyWithZone</span><span class="p">(</span><span class="n">CCZone</span><span class="o">*</span> <span class="n">pZone</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">CC_DLL</span> <span class="n">CCObject</span> <span class="o">:</span> <span class="k">public</span> <span class="n">CCCopying</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">int</span>        <span class="n">m_uID</span><span class="p">;</span><span class="c1">//这两个是支持lua等脚本语言用的, 我们不去管他.</span>
</span><span class='line'>    <span class="kt">int</span>                 <span class="n">m_nLuaID</span><span class="p">;</span>
</span><span class='line'><span class="k">protected</span><span class="o">:</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">int</span>        <span class="n">m_uReference</span><span class="p">;</span><span class="c1">//引用计数</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">int</span>        <span class="n">m_uAutoReleaseCount</span><span class="p">;</span><span class="c1">//autorelease计数</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>    <span class="n">CCObject</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'>    <span class="k">virtual</span> <span class="o">~</span><span class="n">CCObject</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">void</span> <span class="n">release</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">void</span> <span class="n">retain</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'>    <span class="n">CCObject</span><span class="o">*</span> <span class="n">autorelease</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'>    <span class="n">CCObject</span><span class="o">*</span> <span class="n">copy</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">bool</span> <span class="n">isSingleReference</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">retainCount</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'>    <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">isEqual</span><span class="p">(</span><span class="k">const</span> <span class="n">CCObject</span><span class="o">*</span> <span class="n">pObject</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">update</span><span class="p">(</span><span class="kt">float</span> <span class="n">dt</span><span class="p">)</span> <span class="p">{</span><span class="n">CC_UNUSED_PARAM</span><span class="p">(</span><span class="n">dt</span><span class="p">);};</span>
</span><span class='line'>   <span class="c1">//CCAutoreleasePool作为友元类 </span>
</span><span class='line'>    <span class="k">friend</span> <span class="k">class</span> <span class="nc">CCAutoreleasePool</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//几个常用的函数指针.</span>
</span><span class='line'><span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="n">CCObject</span><span class="o">::*</span><span class="n">SEL_SCHEDULE</span><span class="p">)(</span><span class="kt">float</span><span class="p">);</span>
</span><span class='line'><span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="n">CCObject</span><span class="o">::*</span><span class="n">SEL_CallFunc</span><span class="p">)();</span>
</span><span class='line'><span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="n">CCObject</span><span class="o">::*</span><span class="n">SEL_CallFuncN</span><span class="p">)(</span><span class="n">CCNode</span><span class="o">*</span><span class="p">);</span>
</span><span class='line'><span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="n">CCObject</span><span class="o">::*</span><span class="n">SEL_CallFuncND</span><span class="p">)(</span><span class="n">CCNode</span><span class="o">*</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span><span class="p">);</span>
</span><span class='line'><span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="n">CCObject</span><span class="o">::*</span><span class="n">SEL_CallFuncO</span><span class="p">)(</span><span class="n">CCObject</span><span class="o">*</span><span class="p">);</span>
</span><span class='line'><span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="n">CCObject</span><span class="o">::*</span><span class="n">SEL_MenuHandler</span><span class="p">)(</span><span class="n">CCObject</span><span class="o">*</span><span class="p">);</span>
</span><span class='line'><span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="n">CCObject</span><span class="o">::*</span><span class="n">SEL_EventHandler</span><span class="p">)(</span><span class="n">CCEvent</span><span class="o">*</span><span class="p">);</span>
</span><span class='line'><span class="k">typedef</span> <span class="kt">int</span> <span class="p">(</span><span class="n">CCObject</span><span class="o">::*</span><span class="n">SEL_Compare</span><span class="p">)(</span><span class="n">CCObject</span><span class="o">*</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define schedule_selector(_SELECTOR) (SEL_SCHEDULE)(&amp;_SELECTOR)</span>
</span><span class='line'><span class="cp">#define callfunc_selector(_SELECTOR) (SEL_CallFunc)(&amp;_SELECTOR)</span>
</span><span class='line'><span class="cp">#define callfuncN_selector(_SELECTOR) (SEL_CallFuncN)(&amp;_SELECTOR)</span>
</span><span class='line'><span class="cp">#define callfuncND_selector(_SELECTOR) (SEL_CallFuncND)(&amp;_SELECTOR)</span>
</span><span class='line'><span class="cp">#define callfuncO_selector(_SELECTOR) (SEL_CallFuncO)(&amp;_SELECTOR)</span>
</span><span class='line'><span class="cp">#define menu_selector(_SELECTOR) (SEL_MenuHandler)(&amp;_SELECTOR)</span>
</span><span class='line'><span class="cp">#define event_selector(_SELECTOR) (SEL_EventHandler)(&amp;_SELECTOR)</span>
</span><span class='line'><span class="cp">#define compare_selector(_SELECTOR) (SEL_Compare)(&amp;_SELECTOR)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>CCobject.cpp   (CCObject.cpp)</span> <a href='/downloads/code/cocos2d-x-research/2.1.1/cocos2dx/cocoa/CCObject.cpp'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="n">CCObject</span><span class="o">*</span> <span class="n">CCCopying</span><span class="o">::</span><span class="n">copyWithZone</span><span class="p">(</span><span class="n">CCZone</span> <span class="o">*</span><span class="n">pZone</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span><span class="c1">//CCObject的派生类需要调用copy()则必须重写该函数</span>
</span><span class='line'>    <span class="n">CC_UNUSED_PARAM</span><span class="p">(</span><span class="n">pZone</span><span class="p">);</span>
</span><span class='line'>    <span class="n">CCAssert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;not implement&quot;</span><span class="p">);</span><span class="c1">//不重写会报错.</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">CCObject</span><span class="o">::</span><span class="n">CCObject</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="o">:</span><span class="n">m_uAutoReleaseCount</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="p">,</span><span class="n">m_uReference</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">// 引用计数默认为1</span>
</span><span class='line'><span class="p">,</span><span class="n">m_nLuaID</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uObjectCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">m_uID</span> <span class="o">=</span> <span class="o">++</span><span class="n">uObjectCount</span><span class="p">;</span><span class="c1">//脚本语言相关, 不去管他.</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">CCObject</span><span class="o">::~</span><span class="n">CCObject</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span><span class="c1">//析构函数</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">m_uAutoReleaseCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span><span class="c1">//自动引用计数则从管理池中删除</span>
</span><span class='line'>        <span class="n">CCPoolManager</span><span class="o">::</span><span class="n">sharedPoolManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">removeObject</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">m_nLuaID</span><span class="p">)</span><span class="c1">//脚本语言相关.</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">CCScriptEngineManager</span><span class="o">::</span><span class="n">sharedManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getScriptEngine</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">removeScriptObjectByCCObject</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>    <span class="p">{</span><span class="c1">//看起来脚本语言支持被深度嵌入, 如果能设置个宏直接去掉其支持多好.</span>
</span><span class='line'>        <span class="n">CCScriptEngineProtocol</span><span class="o">*</span> <span class="n">pEngine</span> <span class="o">=</span> <span class="n">CCScriptEngineManager</span><span class="o">::</span><span class="n">sharedManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getScriptEngine</span><span class="p">();</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">pEngine</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">pEngine</span><span class="o">-&gt;</span><span class="n">getScriptType</span><span class="p">()</span> <span class="o">==</span> <span class="n">kScriptTypeJavascript</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">pEngine</span><span class="o">-&gt;</span><span class="n">removeScriptObjectByCCObject</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// copy实质上是对copyWithZone的调用.</span>
</span><span class='line'><span class="n">CCObject</span><span class="o">*</span> <span class="n">CCObject</span><span class="o">::</span><span class="n">copy</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">copyWithZone</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">CCObject</span><span class="o">::</span><span class="n">release</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">CCAssert</span><span class="p">(</span><span class="n">m_uReference</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;reference count should greater than 0&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="o">--</span><span class="n">m_uReference</span><span class="p">;</span><span class="c1">//引用计数自减</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">m_uReference</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span><span class="c1">//如果引用计数为0, 调用release会立即释放内存.</span>
</span><span class='line'>        <span class="k">delete</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">CCObject</span><span class="o">::</span><span class="n">retain</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">CCAssert</span><span class="p">(</span><span class="n">m_uReference</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;reference count should greater than 0&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="o">++</span><span class="n">m_uReference</span><span class="p">;</span><span class="c1">//引用计数自增.</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">CCObject</span><span class="o">*</span> <span class="n">CCObject</span><span class="o">::</span><span class="n">autorelease</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span><span class="c1">//autorelease将对象加入自动内存管理池.</span>
</span><span class='line'>    <span class="n">CCPoolManager</span><span class="o">::</span><span class="n">sharedPoolManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">addObject</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">bool</span> <span class="n">CCObject</span><span class="o">::</span><span class="n">isSingleReference</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span><span class="c1">//判断对象是否仅被引用了一次</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">m_uReference</span> <span class="o">==</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">CCObject</span><span class="o">::</span><span class="n">retainCount</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span><span class="c1">//返回引用次数</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">m_uReference</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">bool</span> <span class="n">CCObject</span><span class="o">::</span><span class="n">isEqual</span><span class="p">(</span><span class="k">const</span> <span class="n">CCObject</span> <span class="o">*</span><span class="n">pObject</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span><span class="c1">//判断对象是否为同一个对象.</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">this</span> <span class="o">==</span> <span class="n">pObject</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li>参考1: http://4137613.blog.51cto.com/4127613/784134</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[2d-x深读2:CCPlatformMacros.h]]></title>
    <link href="http://young40.github.com/blog/2012/12/17/cocos2d-x-source-code-research-2-ccplatformmacros-dot-h/"/>
    <updated>2012-12-17T01:49:00+08:00</updated>
    <id>http://young40.github.com/blog/2012/12/17/cocos2d-x-source-code-research-2-ccplatformmacros-dot-h</id>
    <content type="html"><![CDATA[<ul>
<li>路径:<code>cocos2d-2.1beta3-x-2.1.0/cocos2dx/include/ccConfig.h</code></li>
<li>路径:<code>cocos2d-2.1beta3-x-2.1.0/cocos2dx/platform/mac/CCPlatformDefine.h</code> //注意我是以mac平台研究的, 其他平台略有不同</li>
<li>路径:<code>cocos2d-2.1beta3-x-2.1.0/cocos2dx/platform/CCPlatformMacros.h</code></li>
</ul>


<!--more-->


<p>``` cpp ccConfig.h</p>

<h1>include "platform/CCPlatformConfig.h"</h1>

<p>//设置为1后会include CCPhysicsScript 和 CCPhysicsDebugNode 添加到物理引擎支持
//需要保证Chipmunk在搜索路径中</p>

<h1>ifndef CC_ENABLE_CHIPMUNK_INTEGRATION</h1>

<h1>define CC_ENABLE_CHIPMUNK_INTEGRATION 0</h1>

<h1>endif</h1>

<p>//设置为1后会include CCPhysicsScript 添加到Box2D的支持
//同样需要保证Box2D会在搜索路径中</p>

<h1>ifndef CC_ENABLE_BOX2D_INTEGRATION</h1>

<h1>define CC_ENABLE_BOX2D_INTEGRATION 0</h1>

<h1>endif</h1>

<p>/**
 设置为1后,2d学会维护一个OpenGL状态缓存来避免不必要的切换
 为了使用这个功能,需要用下列函数来替换GL的对应函数</p>

<pre><code>- ccGLUseProgram() instead of glUseProgram()
- ccGLDeleteProgram() instead of glDeleteProgram()
- ccGLBlendFunc() instead of glBlendFunc()
</code></pre>

<p>如果这个功能被禁止, 那么这些函数会直接调用对应的GL函数, 当然就没有缓存了
打开这个功能能提高速度
如果你的代码是从GL ES 1.1升级过来的, 保持这个功能被禁用. 如果各种功能正常的话, 你可以启用这个功能</p>

<h1>ifndef CC_ENABLE_GL_STATE_CACHE</h1>

<h1>define CC_ENABLE_GL_STATE_CACHE 1</h1>

<h1>endif</h1>

<p>/<em><em>
启用后,纹理的坐标会用这个公式来计算
- texCoord.left = (rect.origin.x</em>2+1) / (texture.wide</em>2);
- texCoord.right = texCoord.left + (rect.size.width<em>2-2)/(texture.wide</em>2);</p>

<p>The same for bottom and top.</p>

<p>This formula prevents artifacts by using 99% of the texture.
The "correct" way to prevent artifacts is by using the spritesheet-artifact-fixer.py or a similar tool.</p>

<p>受影响的类:
- CCSprite / CCSpriteBatchNode and subclasses: CCLabelBMFont, CCTMXTiledMap
- CCLabelAtlas
- CCQuadParticleSystem
- CCTileMap
*/</p>

<h1>ifndef CC_FIX_ARTIFACTS_BY_STRECHING_TEXEL</h1>

<h1>define CC_FIX_ARTIFACTS_BY_STRECHING_TEXEL 0</h1>

<h1>endif</h1>

<p>//默认0.5秒, 更新下FPS的数据. 数字越大FPS数据越可靠.</p>

<h1>ifndef CC_DIRECTOR_STATS_INTERVAL</h1>

<h1>define CC_DIRECTOR_STATS_INTERVAL (0.5f)</h1>

<h1>endif</h1>

<p>//FPS数据显示位置,默认左下</p>

<h1>ifndef CC_DIRECTOR_FPS_POSITION</h1>

<h1>define CC_DIRECTOR_FPS_POSITION ccp(0,0)</h1>

<h1>endif</h1>

<p>/** @def CC_DIRECTOR_DISPATCH_FAST_EVENTS
 If enabled, and only when it is used with CCFastDirector, the main loop will wait 0.04 seconds to
 dispatch all the events, even if there are not events to dispatch.
 If your game uses lot's of events (eg: touches) it might be a good idea to enable this feature.
 Otherwise, it is safe to leave it disabled.</p>

<p> To enable set it to 1. Disabled by default.</p>

<p> @warning This feature is experimental
 */</p>

<h1>ifndef CC_DIRECTOR_DISPATCH_FAST_EVENTS</h1>

<p> #define CC_DIRECTOR_DISPATCH_FAST_EVENTS 0</p>

<h1>endif</h1>

<p>/** @def CC_DIRECTOR_MAC_USE_DISPLAY_LINK_THREAD
If enabled, cocos2d-mac will run on the Display Link thread. If disabled cocos2d-mac will run in its own thread.</p>

<p>If enabled, the images will be drawn at the "correct" time, but the events might not be very responsive.
If disabled, some frames might be skipped, but the events will be dispatched as they arrived.</p>

<p>To enable set it to a 1, to disable it set to 0. Enabled by default.</p>

<p>Only valid for cocos2d-mac. Not supported on cocos2d-ios.</p>

<p>*/</p>

<h1>ifndef CC_DIRECTOR_MAC_USE_DISPLAY_LINK_THREAD</h1>

<h1>define CC_DIRECTOR_MAC_USE_DISPLAY_LINK_THREAD 1</h1>

<h1>endif</h1>

<p>/** @def CC_NODE_RENDER_SUBPIXEL
 If enabled, the CCNode objects (CCSprite, CCLabel,etc) will be able to render in subpixels.
 If disabled, integer pixels will be used.</p>

<p> To enable set it to 1. Enabled by default.
 */</p>

<h1>ifndef CC_NODE_RENDER_SUBPIXEL</h1>

<h1>define CC_NODE_RENDER_SUBPIXEL 1</h1>

<h1>endif</h1>

<p>/** @def CC_SPRITEBATCHNODE_RENDER_SUBPIXEL
 If enabled, the CCSprite objects rendered with CCSpriteBatchNode will be able to render in subpixels.
 If disabled, integer pixels will be used.</p>

<p> To enable set it to 1. Enabled by default.
 */</p>

<h1>ifndef CC_SPRITEBATCHNODE_RENDER_SUBPIXEL</h1>

<h1>define CC_SPRITEBATCHNODE_RENDER_SUBPIXEL    1</h1>

<h1>endif</h1>

<p>/** @def CC_TEXTURE_ATLAS_USE_TRIANGLE_STRIP
 Use GL_TRIANGLE_STRIP instead of GL_TRIANGLES when rendering the texture atlas.
 It seems it is the recommend way, but it is much slower, so, enable it at your own risk</p>

<p> To enable set it to a value different than 0. Disabled by default.</p>

<p> */</p>

<h1>ifndef CC_TEXTURE_ATLAS_USE_TRIANGLE_STRIP</h1>

<h1>define CC_TEXTURE_ATLAS_USE_TRIANGLE_STRIP 0</h1>

<h1>endif</h1>

<p>//VAO定点数组对象
/** @def CC_TEXTURE_ATLAS_USE_VAO
 By default, CCTextureAtlas (used by many cocos2d classes) will use VAO (Vertex Array Objects).
 Apple recommends its usage but they might consume a lot of memory, specially if you use many of them.
 So for certain cases, where you might need hundreds of VAO objects, it might be a good idea to disable it.</p>

<p> To disable it set it to 0. Enabled by default.</p>

<p> */</p>

<h1>ifndef CC_TEXTURE_ATLAS_USE_VAO</h1>

<pre><code>#if (CC_TARGET_PLATFORM == CC_PLATFORM_IOS) || (CC_TARGET_PLATFORM == CC_PLATFORM_MAC)
    #define CC_TEXTURE_ATLAS_USE_VAO 1
#else
    /* Some Windows display adapter driver cannot support VAO. */
    /* Some android devices cannot support VAO very well, so we disable it by default for android platform. */
    /* Blackberry also doesn't support this feature. */
    #define CC_TEXTURE_ATLAS_USE_VAO 0
#endif
</code></pre>

<h1>endif</h1>

<p>/** @def CC_USE_LA88_LABELS
 If enabled, it will use LA88 (Luminance Alpha 16-bit textures) for CCLabelTTF objects.
 If it is disabled, it will use A8 (Alpha 8-bit textures).
 LA88 textures are 6% faster than A8 textures, but they will consume 2x memory.</p>

<p> This feature is enabled by default.</p>

<p> @since v0.99.5
 */</p>

<h1>ifndef CC_USE_LA88_LABELS</h1>

<h1>define CC_USE_LA88_LABELS 1</h1>

<h1>endif</h1>

<p>/<em>*
  启用后,所有CCSprite的子类都会花上一个边框,方便调试
 0 -- disabled
 1 -- draw bounding box
 2 -- draw texture box
</em>/</p>

<h1>ifndef CC_SPRITE_DEBUG_DRAW</h1>

<h1>define CC_SPRITE_DEBUG_DRAW 0</h1>

<h1>endif</h1>

<p>//CCSpriteBatchNode的调试用加边框</p>

<h1>ifndef CC_SPRITEBATCHNODE_DEBUG_DRAW</h1>

<h1>define CC_SPRITEBATCHNODE_DEBUG_DRAW 0</h1>

<h1>endif</h1>

<p>//CCLabelBMFont调试加边框</p>

<h1>ifndef CC_LABELBMFONT_DEBUG_DRAW</h1>

<h1>define CC_LABELBMFONT_DEBUG_DRAW 0</h1>

<h1>endif</h1>

<p>//LabeltAtlas调试加边框</p>

<h1>ifndef CC_LABELATLAS_DEBUG_DRAW</h1>

<h1>define CC_LABELATLAS_DEBUG_DRAW 0</h1>

<h1>endif</h1>

<p>/** @def CC_ENABLE_PROFILERS
 If enabled, will activate various profilers within cocos2d. This statistical data will be output to the console
 once per second showing average time (in milliseconds) required to execute the specific routine(s).
 Useful for debugging purposes only. It is recommended to leave it disabled.</p>

<p> To enable set it to a value different than 0. Disabled by default.
 */</p>

<h1>ifndef CC_ENABLE_PROFILERS</h1>

<h1>define CC_ENABLE_PROFILERS 0</h1>

<h1>endif</h1>

<p>/<em>* Enable Lua engine debug log </em>/</p>

<h1>ifndef CC_LUA_ENGINE_DEBUG</h1>

<h1>define CC_LUA_ENGINE_DEBUG 0</h1>

<h1>endif</h1>

<p>```</p>

<p>``` cpp mac/CCPlatformDefine.h</p>

<h1>include &lt;assert.h> //引入assert</h1>

<h1>define CC_DLL //CC_DLL只在win32平台下有效</h1>

<h1>if CC_DISABLE_ASSERT > 0</h1>

<h1>define CC_ASSERT(cond) //禁用了assert</h1>

<h1>else</h1>

<h1>define CC_ASSERT(cond) assert(cond) //启用了assert</h1>

<h1>endif</h1>

<h1>define CC_UNUSED_PARAM(unusedparam) (void)unusedparam</h1>

<p>//定义空指针</p>

<h1>ifndef NULL</h1>

<h1>ifdef __cplusplus</h1>

<h1>define NULL    0</h1>

<h1>else</h1>

<h1>define NULL    ((void *)0)</h1>

<h1>endif</h1>

<h1>endif</h1>

<p><code>
我们可以看到win32中不同的部分比如`CC_DLL`
</code> cpp win32/CCPlatformDefine.h</p>

<h1>if defined(_USRDLL)</h1>

<pre><code>#define CC_DLL     __declspec(dllexport)
</code></pre>

<h1>else         /<em> use a DLL library </em>/</h1>

<pre><code>#define CC_DLL     __declspec(dllimport)
</code></pre>

<h1>endif</h1>

<p>```</p>

<p>Linux部分也是<code>CC_DLL</code>不同
``` cpp linux/CCPlatformDefine.h</p>

<h1>if defined(_USRDLL)</h1>

<h1>define CC_DLL <strong>attribute</strong> ((visibility ("default")))</h1>

<h1>else         /<em> use a DLL library </em>/</h1>

<h1>define CC_DLL <strong>attribute</strong> ((visibility ("default")))</h1>

<h1>endif</h1>

<p>```</p>

<p>Android中比较不同的部分是<code>CC_ASSERT</code>
``` cpp android/CCPlatformDefine.h</p>

<h1>define CC_ASSERT(cond) \</h1>

<p>if (! (cond)) \
{ \</p>

<pre><code>char content[256]; \
sprintf(content, "%s function:%s line:%d", __FILE__, __FUNCTION__, __LINE__);  \
CCMessageBox(content, "Assert error"); \
</code></pre>

<p>}
```</p>

<p>我们最后再来看下<code>CCPlatformMacros.h</code>
``` cpp CCPlatformMacros.h</p>

<h1>include "ccConfig.h"</h1>

<h1>include "CCPlatformConfig.h"</h1>

<h1>include "CCPlatformDefine.h"</h1>

<p>//CREATE_FUNC是2d-x的一个核心功能,一般采用例如<code>MySpriter *my = MySpriter::create()</code>的形式调用.
//这里的create()成员函数即是由CREATE_FUNC创建, 来达到让2d-x来管理内存分配的功能</p>

<h1>define CREATE_FUNC(<strong>TYPE</strong>) \</h1>

<p>static <strong>TYPE</strong>* create() \
{ \</p>

<pre><code>__TYPE__ *pRet = new __TYPE__(); \
if (pRet &amp;&amp; pRet-&gt;init()) \
{ \
    pRet-&gt;autorelease(); \
    return pRet; \
} \
else \
{ \
    delete pRet; \
    pRet = NULL; \
    return NULL; \
} \
</code></pre>

<p>}
//早期版本还有一个NODE_FUNC完成和CREATE_FUNC一样的功能,已经废弃,不再讨论</p>

<p>//CC_ENABLE_CACHE_TEXTURE_DATA 只在Android上启用, 会缓存纹理</p>

<h1>if (CC_TARGET_PLATFORM == CC_PLATFORM_ANDROID)</h1>

<pre><code>#define CC_ENABLE_CACHE_TEXTURE_DATA       1
</code></pre>

<h1>else</h1>

<pre><code>#define CC_ENABLE_CACHE_TEXTURE_DATA       0
</code></pre>

<h1>endif</h1>

<h1>if (CC_TARGET_PLATFORM == CC_PLATFORM_ANDROID) || (CC_TARGET_PLATFORM == CC_PLATFORM_WIN32)</h1>

<p>//重新绑定indices, 避免在android和win32下glDrawElements函数crash的bug</p>

<pre><code>#define CC_REBIND_INDICES_BUFFER  1
</code></pre>

<h1>else</h1>

<pre><code>#define CC_REBIND_INDICES_BUFFER  0
</code></pre>

<h1>endif</h1>

<p>//常用宏定义</p>

<h1>ifdef __cplusplus //namespace只在C++中起作用</h1>

<pre><code>#define NS_CC_BEGIN                     namespace cocos2d {
#define NS_CC_END                       }
#define USING_NS_CC                     using namespace cocos2d  //应该尽量使用USING_NS_CC, 兼容性更好
</code></pre>

<h1>else</h1>

<pre><code>#define NS_CC_BEGIN 
#define NS_CC_END 
#define USING_NS_CC 
</code></pre>

<h1>endif</h1>

<p>//成员函数快捷声明/定义宏
//多使用这些宏, 可以方便地定义出合乎面向对象原则的成员变量.
//需要注意的是这些调用了这些宏之后, 应该养成重新写public, private等标号的习惯. 因为之后的都会变成public
//定义的成员变量都是protected的
//只读的成员变量</p>

<h1>define CC_PROPERTY_READONLY(varType, varName, funName)\</h1>

<p>protected: varType varName;\
public: virtual varType get##funName(void);</p>

<p>//getter是为引用</p>

<h1>define CC_PROPERTY_READONLY_PASS_BY_REF(varType, varName, funName)\</h1>

<p>protected: varType varName;\
public: virtual const varType&amp; get##funName(void);</p>

<p>//可读可写成员变量</p>

<h1>define CC_PROPERTY(varType, varName, funName)\</h1>

<p>protected: varType varName;\
public: virtual varType get##funName(void);\
public: virtual void set##funName(varType var);</p>

<h1>define CC_PROPERTY_PASS_BY_REF(varType, varName, funName)\</h1>

<p>protected: varType varName;\
public: virtual varType get##funName(void);\
public: virtual void set##funName(const varType&amp; var);</p>

<p>//以上的getter,setter只有声明, 下面的这些带有定义</p>

<h1>define CC_SYNTHESIZE_READONLY(varType, varName, funName)\</h1>

<p>protected: varType varName;\
public: virtual varType get##funName(void) const { return varName; }</p>

<h1>define CC_SYNTHESIZE_READONLY_PASS_BY_REF(varType, varName, funName)\</h1>

<p>protected: varType varName;\
public: virtual const varType&amp; get##funName(void) const { return varName; }</p>

<h1>define CC_SYNTHESIZE(varType, varName, funName)\</h1>

<p>protected: varType varName;\
public: virtual varType get##funName(void) const { return varName; }\
public: virtual void set##funName(varType var){ varName = var; }</p>

<h1>define CC_SYNTHESIZE_PASS_BY_REF(varType, varName, funName)\</h1>

<p>protected: varType varName;\
public: virtual varType get##funName(void) const { return varName; }\
public: virtual void set##funName(const varType&amp; var){ varName = var; }</p>

<p>//setter中会retain一次var, 防止被gc回收.</p>

<h1>define CC_SYNTHESIZE_RETAIN(varType, varName, funName)    \</h1>

<p>private: varType varName; \
public: virtual varType get##funName(void) const { return varName; } \
public: virtual void set##funName(varType var)   \
{ \</p>

<pre><code>if (varName != var) \
{ \
    CC_SAFE_RETAIN(var); \
    CC_SAFE_RELEASE(varName); \
    varName = var; \
} \
</code></pre>

<p>}</p>

<h1>define CC_SAFE_DELETE(p)            do { if(p) { delete (p); (p) = 0; } } while(0)</h1>

<h1>define CC_SAFE_DELETE_ARRAY(p)     do { if(p) { delete[] (p); (p) = 0; } } while(0)</h1>

<h1>define CC_SAFE_FREE(p)                do { if(p) { free(p); (p) = 0; } } while(0)</h1>

<h1>define CC_SAFE_RELEASE(p)            do { if(p) { (p)->release(); } } while(0)</h1>

<h1>define CC_SAFE_RELEASE_NULL(p)        do { if(p) { (p)->release(); (p) = 0; } } while(0)</h1>

<h1>define CC_SAFE_RETAIN(p)            do { if(p) { (p)->retain(); } } while(0)</h1>

<h1>define CC_BREAK_IF(cond)            if(cond) break</h1>

<h1>define __CCLOGWITHFUNCTION(s, ...) \</h1>

<pre><code>CCLog("%s : %s",__FUNCTION__, CCString::createWithFormat(s, ##__VA_ARGS__)-&gt;getCString())
</code></pre>

<p>//这个宏定义要注意大小写, 会很容易和cocos2d::CCLog弄错, 因为代码提示的问题.
// cocos2d debug</p>

<h1>if !defined(COCOS2D_DEBUG) || COCOS2D_DEBUG == 0</h1>

<h1>define CCLOG(...)       do {} while (0)</h1>

<h1>define CCLOGINFO(...)   do {} while (0)</h1>

<h1>define CCLOGERROR(...)  do {} while (0)</h1>

<h1>define CCLOGWARN(...)   do {} while (0)</h1>

<h1>elif COCOS2D_DEBUG == 1</h1>

<h1>define CCLOG(format, ...)      cocos2d::CCLog(format, ##<strong>VA_ARGS</strong>)</h1>

<h1>define CCLOGERROR(format,...)  cocos2d::CCLog(format, ##<strong>VA_ARGS</strong>)</h1>

<h1>define CCLOGINFO(format,...)   do {} while (0)</h1>

<h1>define CCLOGWARN(...) <strong>CCLOGWITHFUNCTION(</strong>VA_ARGS__)</h1>

<h1>elif COCOS2D_DEBUG > 1</h1>

<h1>define CCLOG(format, ...)      cocos2d::CCLog(format, ##<strong>VA_ARGS</strong>)</h1>

<h1>define CCLOGERROR(format,...)  cocos2d::CCLog(format, ##<strong>VA_ARGS</strong>)</h1>

<h1>define CCLOGINFO(format,...)   cocos2d::CCLog(format, ##<strong>VA_ARGS</strong>)</h1>

<h1>define CCLOGWARN(...) <strong>CCLOGWITHFUNCTION(</strong>VA_ARGS__)</h1>

<h1>endif // COCOS2D_DEBUG</h1>

<p>// Lua engine debug</p>

<h1>if !defined(COCOS2D_DEBUG) || COCOS2D_DEBUG == 0 || CC_LUA_ENGINE_DEBUG == 0</h1>

<h1>define LUALOG(...)</h1>

<h1>else</h1>

<h1>define LUALOG(format, ...)     cocos2d::CCLog(format, ##<strong>VA_ARGS</strong>)</h1>

<h1>endif // Lua engine debug</h1>

<p>//定义废弃(deprecated)属性</p>

<h1>if defined(<strong>GNUC</strong>) &amp;&amp; ((<strong>GNUC</strong> >= 4) || ((<strong>GNUC</strong> == 3) &amp;&amp; (<strong>GNUC_MINOR</strong> >= 1)))</h1>

<pre><code>#define CC_DEPRECATED_ATTRIBUTE __attribute__((deprecated))
</code></pre>

<h1>elif _MSC_VER >= 1400 //vs 2005 or higher</h1>

<pre><code>#define CC_DEPRECATED_ATTRIBUTE __declspec(deprecated) 
</code></pre>

<h1>else</h1>

<pre><code>#define CC_DEPRECATED_ATTRIBUTE
</code></pre>

<h1>endif</h1>

<p>```</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[2d-x深读1:CCPlatformConfig.h]]></title>
    <link href="http://young40.github.com/blog/2012/12/17/cocos2d-x-source-code-research-1-ccplatformconfig-dot-h/"/>
    <updated>2012-12-17T00:43:00+08:00</updated>
    <id>http://young40.github.com/blog/2012/12/17/cocos2d-x-source-code-research-1-ccplatformconfig-dot-h</id>
    <content type="html"><![CDATA[<p>准备好好学习下Cocos2d-x(以下简称2dx), 我正在很努力地学习C++.</p>

<p>作为新手的我, 只能从最基本的代码读起. 就从<code>CCPlatformConfig.h</code>开始研究起吧, 这个文件没有include其他文件, 是最基本的文件.</p>

<p>研究成果见代码.</p>

<!--more-->


<ul>
<li>版本:<code>cocos2d-2.1beta3-x-2.1.0</code></li>
<li>路径:<code>cocos2d-2.1beta3-x-2.1.0/cocos2dx/platform</code></li>
</ul>


<p>``` cpp CCPlatformConfig.h</p>

<h1>ifndef <strong>CC_PLATFORM_CONFIG_H</strong></h1>

<h1>define <strong>CC_PLATFORM_CONFIG_H</strong></h1>

<p>/<em>*
  Config of cocos2d-x project, per target platform.
  </em>/</p>

<p>//////////////////////////////////////////////////////////////////////////
// pre configure
//////////////////////////////////////////////////////////////////////////</p>

<p>// define supported target platform macro which CC uses.</p>

<h1>define CC_PLATFORM_UNKNOWN            0</h1>

<h1>define CC_PLATFORM_IOS                1</h1>

<h1>define CC_PLATFORM_ANDROID            2</h1>

<h1>define CC_PLATFORM_WIN32              3</h1>

<h1>define CC_PLATFORM_MARMALADE          4</h1>

<h1>define CC_PLATFORM_LINUX              5</h1>

<h1>define CC_PLATFORM_BADA               6</h1>

<h1>define CC_PLATFORM_BLACKBERRY         7</h1>

<h1>define CC_PLATFORM_MAC                8</h1>

<p>//默认是unknown的
// Determine target platform by compile environment macro.</p>

<h1>define CC_TARGET_PLATFORM             CC_PLATFORM_UNKNOWN</h1>

<p>//CC_TARGET_OS_MAC等是从编译器的环境变量传入的. 参加各编译器或者IDE的预定义宏设置</p>

<p>// mac</p>

<h1>if defined(CC_TARGET_OS_MAC)</h1>

<h1>undef  CC_TARGET_PLATFORM //先取消定义</h1>

<h1>define CC_TARGET_PLATFORM         CC_PLATFORM_MAC //定义为MAC平台</h1>

<h1>endif</h1>

<p>// iphone</p>

<h1>if defined(CC_TARGET_OS_IPHONE)</h1>

<pre><code>#undef  CC_TARGET_PLATFORM
#define CC_TARGET_PLATFORM         CC_PLATFORM_IOS
#define CC_SUPPORT_PVRTC //支持prv压缩格式
</code></pre>

<h1>endif</h1>

<p>// android</p>

<h1>if defined(ANDROID)</h1>

<pre><code>#undef  CC_TARGET_PLATFORM
#define CC_TARGET_PLATFORM         CC_PLATFORM_ANDROID
</code></pre>

<h1>endif</h1>

<p>// win32</p>

<h1>if defined(WIN32) &amp;&amp; defined(_WINDOWS)</h1>

<pre><code>#undef  CC_TARGET_PLATFORM
#define CC_TARGET_PLATFORM         CC_PLATFORM_WIN32
</code></pre>

<h1>endif</h1>

<p>// linux</p>

<h1>if defined(LINUX)</h1>

<pre><code>#undef  CC_TARGET_PLATFORM
#define CC_TARGET_PLATFORM         CC_PLATFORM_LINUX
</code></pre>

<h1>endif</h1>

<p>// marmalade</p>

<h1>if defined(MARMALADE)</h1>

<h1>undef  CC_TARGET_PLATFORM</h1>

<h1>define CC_TARGET_PLATFORM         CC_PLATFORM_MARMALADE</h1>

<h1>endif</h1>

<p>// bada</p>

<h1>if defined(SHP)</h1>

<h1>undef  CC_TARGET_PLATFORM</h1>

<h1>define CC_TARGET_PLATFORM         CC_PLATFORM_BADA</h1>

<h1>endif</h1>

<p>// qnx</p>

<h1>if defined(<strong>QNX</strong>)</h1>

<pre><code>#undef  CC_TARGET_PLATFORM
#define CC_TARGET_PLATFORM     CC_PLATFORM_BLACKBERRY
</code></pre>

<h1>endif</h1>

<p>//////////////////////////////////////////////////////////////////////////
// post configure
//////////////////////////////////////////////////////////////////////////</p>

<p>//不支持的平台,如果你在上面平台上遇到这个错误, 就可能是预定义变量, 或者编译器的环境变量设置错误
// check user set platform</p>

<h1>if ! CC_TARGET_PLATFORM</h1>

<pre><code>#error  "Cannot recognize the target platform; are you targeting an unsupported platform?"
</code></pre>

<h1>endif</h1>

<h1>if (CC_TARGET_PLATFORM == CC_PLATFORM_WIN32)</h1>

<h1>pragma warning (disable:4127) //在win32平台不显示4127的warning, 这个具体用法可以参见</h1>

<p>//http://blog.csdn.net/wowolook/article/details/8060334</p>

<h1>endif  // CC_PLATFORM_WIN32</h1>

<h1>endif  // <strong>CC_PLATFORM_CONFIG_H</strong></h1>

<p>```</p>
]]></content>
  </entry>
  
</feed>
