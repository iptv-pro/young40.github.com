
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>基于Pomelo和Cocos2d-x的聊天室 - 喜气羊羊</title>
  <meta name="author" content="Young40">

  
  <meta name="description" content="据说聊天室和游戏系统有很多相似之处, 并且很多游戏本身就带着多人聊天系统. 所以Pomelo将聊天室作为了一个例子. 开源是非常棒的思想和运动, 我简单提两点体会,
1.发现了问题可以不用等官方响应,自己有能力就可以马上修复. 2.你可以贡献自己的代码,很多人都可以贡献代码,可以让项目快速发展. &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://young40.github.com/blog/2013/01/08/chat-of-pomelo-for-cocos2d-x/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="喜气羊羊" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-827720-7']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">喜气羊羊</a></h1>
  
    <h2>代码是一种人生态度</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS" target="_blank">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get" target="_blank">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:young40.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">首页</a></li>
  <li><a href="/blog/archives">文章</a></li>
  <li><a href="/about">关于</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">基于Pomelo和Cocos2d-x的聊天室</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-08T00:39:00+08:00" pubdate data-updated="true">Jan 8<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>据说聊天室和游戏系统有很多相似之处, 并且很多游戏本身就带着多人聊天系统. 所以Pomelo将聊天室作为了一个例子.</p>

<p>开源是非常棒的思想和运动, 我简单提两点体会,
1.发现了问题可以不用等官方响应,自己有能力就可以马上修复. 2.你可以贡献自己的代码,很多人都可以贡献代码,可以让项目快速发展.
当然一旦你的代码被接受并被很多人使用, 心中的成就感是不言而喻的.</p>

<p>之所以要提到开源, 是因为今天我们要用到的东西基本上全部是开源的, 并且我们还要对其中的代码做一些修改才能正常工作. 再一次为开源鼓掌!</p>

<p>这并不是一篇Pomelo,或者Cocos2d-x的入门说明, 需要你对这两者都有一定的了解.
同时, 无论是Pomelo还是Cocos2d-x, 我都是新手, 如果文章中有错误的地方, 希望您能不吝指出.
您可以在文章下面留言, 或者在新浪微博上发微薄 @杨世玲
(需要说明的一点是, 请勿私信提问非隐私性技术问题, 我是希望您的问题, 我的或者其他朋友的回复,能被更多朋友搜索到,
我希望我们的交流, 能让更多朋友受到启发, 受益. 这也是对社区和世界和平的一点贡献吧.)</p>

<!--more-->


<p>下面是我们需要使用到的工具及其版本:</p>

<ul>
<li>平台:OS X(10.8.2) Xcode(4.5.2)</li>
<li>Cocos2d-2.1beta3-x-2.1.0</li>
<li>Pomelo https://github.com/NetEase/pomelo</li>
<li>socket.io-clientpp https://github.com/ebshimizu/socket.io-clientpp</li>
<li>websocketpp https://github.com/zaphoyd/websocketpp</li>
<li>Rapidjson https://code.google.com/p/rapidjson/</li>
<li>chatofpomelo https://github.com/NetEase/chatofpomelo</li>
</ul>


<p>查阅本文时请注意版本差异.</p>

<h3>环境配置</h3>

<p>我们的目标是实现OS X, IOS, Android三个平台下的chatofpomelo的Cocos2d-x版本. <br/>
所以需要安装各自平台的开发工具如Xcode,Eclipse,NDK等, 不是本文需要关心的内容. 相信大家也已经轻车熟路了. <br/>
Pomelo的安装 <code>npm install pomelo -g</code>, 如有疑问请查看Pomelo的Wiki. <br/>
websocketpp需要著名的C++库, boost. 我是使用了HomeBrew来安装.
其他安装方式请自省查阅相关文档, 有一点需要指出的是, 必须编译为带有x86(i386)支持lib文件.
因为Cocos2d-x在OS X下是32位的.</p>

<figure class='code'><figcaption><span>HomeBrew安装boost库</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>brew install boost --universal
</span></code></pre></td></tr></table></div></figure>


<p>上面这条命令中<code>--universal</code>即代表编译出来的boost的lib文件同时支持x86和x64.</p>

<h3>项目配置</h3>

<p>Cocos2d-x跨平台无疑做的很好, 但是如果手动创建一个结构良好的跨平台项目,还是一件非常棘手的事. <br/>
幸好我们可以偷懒, 打开Cocos2d-x的源代码, samples目录下面都是已经配置好的跨平台的项目文件.
合理利用, 将事半功倍.</p>

<p>我们将samples目录下HelloCpp复制为ChatOfPomelo,打开找到proj.mac目录下面的<code>HelloCpp.xcodeproj</code>,
可以将其重命名为<code>ChatOfPomelo-Mac.xcodeproj</code>, 以便于和接下来的ios项目有所区分.</p>

<p>在ChatOfPomelo下创建lib目录, 下载socket.io-clientpp和websocketpp并解压到lib目录下面.
并将socket.io-clientpp/lib/rapidjson 复制到lib目录下面.  <br/>
目录结构应该是这样的.</p>

<figure class='code'><figcaption><span>目录</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>ChatOfPomelo/
</span><span class='line'>├── Classes
</span><span class='line'>├── Resources
</span><span class='line'>├── lib
</span><span class='line'>│   ├── rapidjson
</span><span class='line'>│   ├── socket.io-clientpp
</span><span class='line'>│   └── websocketpp
</span><span class='line'>├── proj.android
</span><span class='line'>├── proj.blackberry
</span><span class='line'>├── proj.ios
</span><span class='line'>├── proj.linux
</span><span class='line'>├── proj.mac
</span><span class='line'>├── proj.marmalade
</span><span class='line'>└── proj.win32
</span></code></pre></td></tr></table></div></figure>


<p>我们打开proj.mac下的项目文件, 在Xcode中打开项目设置页, 点开Targets的设置.
在Build Settings下面找到<code>Search Paths</code>, 将<code>Always Search User Paths</code>设置为<code>Yes</code>. <br/>
给<code>Header Search Paths</code> 依次添加下面路径:</p>

<figure class='code'><figcaption><span>目录</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>/usr/local/include_code
</span><span class='line'><span class="s2">&quot;$(SRCROOT)/../lib/socket.io-clientpp/src&quot;</span>
</span><span class='line'><span class="s2">&quot;$(SRCROOT)/../lib/websocketpp/src&quot;</span>
</span><span class='line'><span class="s2">&quot;$(SRCROOT)/../lib/rapidjson/include&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>如下图所示:
<img src="/upload/2013-01/chat-of-pomelo-cocos2d-x-001.png"></p>

<p>给<code>Library Search Paths</code>添加路径<code>/usr/local/lib</code>. 如下图:
<img src="/upload/2013-01/chat-of-pomelo-cocos2d-x-002.png"></p>

<p>其中<code>/usr/local/include</code>和<code>/usr/local/lib</code>是boost的所在位置(HomeBrew的默认安装位置).
如果你的boost不在上述位置, 请自行更改.</p>

<p>接下来将<code>websocketpp</code>的工程文件添加进来.参见下图:    <br/>
<img src="/upload/2013-01/chat-of-pomelo-cocos2d-x-003.png"></p>

<p>然后打开工程的设置, 在Targets的Build Phases页面,找到<code>Link Binary With Libraries</code>,
添加<code>libwebsocketpp.a</code>, 以及boost的库文件(在/usr/local/lib中找到).</p>

<figure class='code'><figcaption><span>boost 需要添加的库文件列表</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>libboost_date_time-mt.a
</span><span class='line'>libboost_graph-mt.a
</span><span class='line'>libboost_random-mt.a
</span><span class='line'>libboost_regex-mt.a
</span><span class='line'>libboost_system-mt.a
</span><span class='line'>libboost_thread-mt.a
</span><span class='line'>libboost_timer-mt.a
</span></code></pre></td></tr></table></div></figure>


<p>添加的方法参见下图:  <br/>
<img src="/upload/2013-01/chat-of-pomelo-cocos2d-x-004.png"></p>

<h2>文件Hack</h2>

<p>我们在<code>HelloWorldScene.cpp</code>中添加一句<code>#include &lt;socket_io_client.hpp&gt;</code>. <br/>
然后试图运行项目的话, 会看到几处报错(有可能你看到这篇文章的时候相关库文件已经更新了, 没有报错的话, 直接跳过这段即可.) <br/>
报错的是<code>socket_io_client.hpp</code>中的<code>std::function</code>以及<code>std::unique_ptr</code>等.</p>

<p>这是因为这些语句是C++11的新语法. 而如果在Xcode中启用C++11的支持,则Cocos2d-x无法通过编译.
原因有人说是Cocos2d-x不支持C++11, 有人说是OS X自带的libc++库太旧的原因, Xcode4.6中会更新该库.
我是小菜鸟一只, 也分不清谁说的对.</p>

<p>但我们可以通过修改这些代码, 采用boost的API来完成相应的工作.
而websocketpp这个项目又大量采用了boost, 所以修改为boost的API还是挺划算的.</p>

<p>找到<code>socket_io_client.hpp</code>:</p>

<figure class='code'><figcaption><span>socket_io_client.hpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="c1">//typedef std::function&lt;void (socketio_events&amp;, const Value&amp;)&gt; eventFunc;</span>
</span><span class='line'><span class="c1">//修改为</span>
</span><span class='line'><span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span> <span class="p">(</span><span class="n">socketio_events</span><span class="o">&amp;</span><span class="p">,</span> <span class="k">const</span> <span class="n">Value</span><span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">eventFunc</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//std::unique_ptr&lt;boost::asio::deadline_timer&gt; m_heartbeatTimer;</span>
</span><span class='line'><span class="c1">//修改为</span>
</span><span class='line'><span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">asio</span><span class="o">::</span><span class="n">deadline_timer</span><span class="o">&gt;</span> <span class="n">m_heartbeatTimer</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>找到<code>socket_io_client.cpp</code>:</p>

<figure class='code'><figcaption><span>socket_io_client.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="c1">//m_heartbeatTimer = std::unique_ptr&lt;boost::asio::deadline_timer&gt;(new boost::asio::deadline_timer(con-&gt;get_io_service(), boost::posix_time::seconds(0)));</span>
</span><span class='line'><span class="c1">//修改为</span>
</span><span class='line'><span class="n">m_heartbeatTimer</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">asio</span><span class="o">::</span><span class="n">deadline_timer</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">boost</span><span class="o">::</span><span class="n">asio</span><span class="o">::</span><span class="n">deadline_timer</span><span class="p">(</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">get_io_service</span><span class="p">(),</span> <span class="n">boost</span><span class="o">::</span><span class="n">posix_time</span><span class="o">::</span><span class="n">seconds</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span>
</span></code></pre></td></tr></table></div></figure>


<p>这是整个项目应该就可以正常编译运行了. 如果没能正常运行, 你可能在某一步出错了,
可以在下面评论分享下你的问题, 如果已经找到解决办法, 也要把解决方法也贴出来, 分享给大家哦, 亲!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Young40</span></span>

      








  


<time datetime="2013-01-08T00:39:00+08:00" pubdate data-updated="true">Jan 8<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/cocos2d-x/'>Cocos2d-x</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/01/03/cocos2d-x-source-code-research-4-ccautoreleasepool/" title="Previous Post: 2d-x深读4:CCAutoReleasePool">&laquo; 2d-x深读4:CCAutoReleasePool</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
<h1>Categories</h1>
<ul id="categories">
    <li class='category'><a href='/blog/categories/cpp/'>CPP (2)</a></li>
<li class='category'><a href='/blog/categories/cocos2d-x/'>Cocos2d-x (10)</a></li>
<li class='category'><a href='/blog/categories/cocos2d-x-源代码研究/'>Cocos2d-x 源代码研究 (4)</a></li>
<li class='category'><a href='/blog/categories/cocosbuilder/'>CocosBuilder (5)</a></li>
<li class='category'><a href='/blog/categories/git/'>Git (1)</a></li>
<li class='category'><a href='/blog/categories/github/'>Github (1)</a></li>
<li class='category'><a href='/blog/categories/os-x/'>OS X (1)</a></li>
<li class='category'><a href='/blog/categories/shell/'>Shell (1)</a></li>
<li class='category'><a href='/blog/categories/vim/'>Vim (1)</a></li>
<li class='category'><a href='/blog/categories/杂谈/'>杂谈 (2)</a></li>

</ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/01/08/chat-of-pomelo-for-cocos2d-x/">基于Pomelo和Cocos2d-x的聊天室</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/03/cocos2d-x-source-code-research-4-ccautoreleasepool/">2d-x深读4:CCAutoReleasePool</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/31/cocos2d-x-source-code-research-3-ccobject/">2d-x深读3:CCObject</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/29/cocosbuilder-step-by-step-part-four/">一步一步CocosBuilder(4)[完结]</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/28/cocosbuilder-step-by-step-part-three/">一步一步CocosBuilder(3)</a>
      </li>
    
  </ul>
</section>






  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Young40 -
  <span class="credit">Powered by <a target="_blank" href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'young40';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://young40.github.com/blog/2013/01/08/chat-of-pomelo-for-cocos2d-x/';
        var disqus_url = 'http://young40.github.com/blog/2013/01/08/chat-of-pomelo-for-cocos2d-x/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
